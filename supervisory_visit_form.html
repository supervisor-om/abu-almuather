<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام التقييم الإشرافي الرقمي المطور</title>
    
    <!-- Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Script for Word Export Functionality -->
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>

    <style>
        /* --- Google Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');

        /* --- Global Styles --- */
        body { 
            font-family: 'Tajawal', sans-serif; 
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
        }

        /* --- Main Container & Views --- */
        .main-container {
            max-width: 900px;
            margin: auto;
            background-color: #ffffff;
            padding: 25px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        #form-view, #dashboard-view, #saved-reports-view { display: none; }
        #form-view.active, #dashboard-view.active, #saved-reports-view.active { display: block; }


        /* --- Navigation & Header --- */
        .top-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .nav-tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            flex-grow: 1;
        }
        .nav-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-family: 'Tajawal', sans-serif;
            font-size: 1.1rem;
            font-weight: 500;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: color 0.2s, border-bottom-color 0.2s;
        }
        .nav-tab:hover { color: #0056b3; }
        .nav-tab.active {
            color: #0056b3;
            font-weight: 700;
            border-bottom-color: #007bff;
        }
       
        /* --- Interactive Form Styles --- */
        .page-header h1 { color: #0056b3; margin: 0; text-align: center;}
        .page-header p { margin: 5px 0 0; color: #666; font-size: 1.1rem; text-align: center;}
        h2 { color: #0056b3; border-right: 4px solid #007bff; padding-right: 10px; margin-top: 30px; }
        details { border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px 15px; margin-bottom: 20px; background-color: #fafafa; }
        summary { cursor: pointer; font-weight: 700; font-size: 1.2rem; color: #0056b3; list-style: none; display: flex; align-items: center; }
        summary::-webkit-details-marker { display: none; }
        summary::before { content: '◀'; margin-left: 10px; font-size: 0.8em; transition: transform 0.2s; }
        details[open] > summary::before { transform: rotate(90deg); }
        .item-card { border: 1px solid #ccc; border-radius: 8px; padding: 15px; margin: 15px 0; background-color: #fdfdfd; transition: box-shadow 0.3s; }
        .item-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
        .item-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;}
        .item-header h4 { margin: 0; font-size: 1.1rem; color: #333; flex-grow: 1; }
        .item-header h4 small { color: #555; font-weight: 400; font-size: 0.9rem;}
        .score { font-size: 2rem; font-weight: bold; color: #333; background-color: #f0f2f5; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; transition: color 0.3s, background-color 0.3s; }
        
        .rating-selector { display: flex; justify-content: space-around; padding: 10px 0; margin-top: 10px; border-top: 1px solid #eee;}
        .rating-btn { padding: 8px 12px; border-radius: 5px; border: 1px solid #ccc; background-color: #f8f9fa; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; }
        .rating-btn:hover { transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .rating-btn.active { font-weight: bold; color: white; border-color: transparent; }
        .rating-btn.active.score-1 { background-color: #155724; }
        .rating-btn.active.score-2 { background-color: #004085; }
        .rating-btn.active.score-3 { background-color: #856404; }
        .rating-btn.active.score-4 { background-color: #721c24; }
        .rating-btn.active.score-5 { background-color: #dc3545; }

        .notes-wrapper { position: relative; }
        .item-notes { width: 100%; box-sizing: border-box; margin-top: 15px; padding: 8px; padding-left: 35px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa; font-size: 0.95rem; min-height: 80px; }
        .item-notes .highlight { color: red; font-weight: bold; }

        .mic-btn { position: absolute; left: 8px; top: 25px; background: none; border: none; cursor: pointer; font-size: 1.2rem; color: #6c757d; transition: color 0.2s;}
        .mic-btn:hover { color: #007bff; }
        .mic-btn.recording { color: #dc3545; }
        
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; align-items: center;}
        .info-grid input, .info-grid select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-family: 'Tajawal', sans-serif; font-size: 1rem; }
        .info-grid .dropdown-wrapper { display: flex; flex-direction: column; gap: 5px; }
        
        .controls { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .controls button { padding: 10px 20px; font-size: 0.9rem; font-family: 'Tajawal', sans-serif; font-weight: 700; cursor: pointer; border: none; border-radius: 5px; color: white; transition: background-color 0.2s, transform 0.1s; }
        .controls button:hover { transform: translateY(-2px); }
        .print-btn { background-color: #28a745; }
        .reset-btn { background-color: #dc3545; }
        .generate-btn { background-color: #007bff; }
        .archive-btn { background-color: #3f51b5; }
        .export-btn { background-color: #17a2b8; }
        #status-message { text-align: center; color: green; margin-top: 15px; font-weight: 500; height: 20px; transition: opacity 0.5s; }
        .report-section { margin-top: 40px; border-top: 2px solid #007bff; padding-top: 20px; }
        .report-box h3 { color: #0056b3; margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
        .report-content-area { width: 100%; box-sizing: border-box; border: 1px solid #dee2e6; border-radius: 4px; background-color: #f8f9fa; font-family: inherit; font-size: 1rem; line-height: 1.7; resize: vertical; min-height: 120px; padding: 8px; margin-top: 10px; }
        .visitor-info { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }

        /* Template Section Styles */
        .template-section { margin-top: 20px; padding: 15px; border: 1px dashed #007bff; border-radius: 8px; background-color: #f8f9fa;}
        .template-controls { display: flex; gap: 10px; align-items: center; }
        .template-controls select { flex-grow: 1; }

        /* --- Dashboard & Saved Reports Styles --- */
        .dashboard-controls { display: flex; gap: 10px; margin-bottom: 20px; align-items: flex-end; flex-wrap: wrap; }
        .dashboard-controls .control-group { flex-grow: 1; }
        .dashboard-controls label { display: block; margin-bottom: 5px; font-weight: 500; }
        .dashboard-controls input, .dashboard-controls select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-family: 'Tajawal', sans-serif; font-size: 1rem;}
        .dashboard-controls button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; height: 45px; }
        #chart-container { margin-top: 20px; height: 450px; }
        #no-data-message, #no-saved-reports-message { text-align: center; color: #6c757d; font-size: 1.2rem; padding: 40px; }
        .saved-report-card {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .saved-report-info { font-size: 1.1rem; }
        .saved-report-info strong { color: #0056b3; }
        .saved-report-actions button {
            padding: 8px 12px;
            margin-right: 5px;
        }


        /* --- Custom Modal Styles --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; max-width: 400px; width: 90%; }
        .modal-buttons { display: flex; justify-content: center; gap: 15px; }
        .modal-buttons button { padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; font-weight: 700; }
        #confirm-reset-btn { background-color: #dc3545; color: white; }
        #cancel-reset-btn { background-color: #6c757d; color: white; }

        /* --- Print-Only Styles --- */
        .print-view { display: none; }

        @media print {
            body { background-color: #fff; padding: 0; margin: 0; font-family: 'Times New Roman', Times, serif; }
            .main-container, .modal-overlay { display: none; }
            .print-view { display: block; }
             .print-main-table, .print-info-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
            .print-main-table th, .print-main-table td, .print-info-table td { border: 1px solid #000; padding: 5px; text-align: center; vertical-align: middle; }
            .print-main-table th { background-color: #f2f2f2 !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            .print-info-table .label { font-weight: bold; background-color: #f2f2f2 !important; -webkit-print-color-adjust: exact; color-adjust: exact; width: 15%; }
            .item-cell { text-align: right !important; }
            .category-cell { font-weight: bold; }
             .report-section-print {
                margin-top: 20px;
                border: 2px solid #000;
                padding: 10px;
                page-break-inside: avoid;
            }
            .report-section-print h3 {
                margin: 0 0 10px 0;
                font-size: 1.2rem;
                background-color: #f2f2f2 !important;
                padding: 5px;
                text-align: center;
                -webkit-print-color-adjust: exact; color-adjust: exact;
                border-bottom: 1px solid #000;
            }
            .print-report-box {
                white-space: pre-wrap;
                text-align: right;
                min-height: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <header class="top-header">
            <nav class="nav-tabs">
                <button class="nav-tab active" onclick="toggleView('form-view')">نموذج التقييم</button>
                <button class="nav-tab" onclick="toggleView('dashboard-view')">لوحة المتابعة</button>
                <button class="nav-tab" onclick="toggleView('saved-reports-view')">التقارير المحفوظة</button>
            </nav>
        </header>

        <div id="form-view" class="active">
            <div class="page-header">
                <h1>استمارة زيارة إشرافية إلكترونية</h1>
                <p>نظام التقييم الإشرافي الرقمي المطور (الرياضة المدرسية)</p>
            </div>
            <main>
                <section class="visit-info">
                    <h2>معلومات الزيارة</h2>
                    <div class="info-grid">
                        <div class="dropdown-wrapper">
                            <select id="school"></select>
                            <input id="school-other" type="text" placeholder="أو أدخل اسم المدرسة يدويًا" style="display: none; margin-top: 5px;">
                        </div>
                        <input id="teacherName" type="text" placeholder="اسم المعلم">
                        <input id="fileNumber" type="text" placeholder="رقم الملف">
                        <input id="subject" type="text" placeholder="المادة" value="الرياضة المدرسية">
                        <input id="visitNumber" type="text" placeholder="رقم الزيارة">
                        <input id="visitDate" type="date" placeholder="التاريخ">
                        <input id="class" type="text" placeholder="الصف">
                        <input id="lesson" type="text" placeholder="الحصة">
                        <input id="topic" type="text" placeholder="الموضوع">
                    </div>
                </section>

                <section class="template-section">
                     <div class="template-controls">
                        <select id="template-select" class="info-grid-input"></select>
                        <button onclick="loadTemplate()" class="generate-btn" style="padding: 8px 12px; font-size: 0.9rem;">تحميل قالب</button>
                        <button onclick="saveTemplate()" class="save-btn" style="padding: 8px 12px; font-size: 0.9rem;">حفظ كقالب</button>
                    </div>
                </section>
                
                <details>
                    <summary>اضغط هنا لعرض معيار التقييم</summary>
                    <div style="padding: 10px;">
                        <ul>
                            <li><b>1 - متميز</b></li>
                            <li><b>2 - جيد</b></li>
                            <li><b>3 - ملائم</b></li>
                            <li><b>4 - غير ملائم</b></li>
                            <li><b>5 - يحتاج إلى تدخل سريع</b></li>
                        </ul>
                    </div>
                </details>

                <form id="evaluationForm">
                    <!-- Item Cards will be generated by JS -->
                </form>
                
                <section id="reportSection" class="report-section" style="display: none;">
                    <h2>التقرير النهائي</h2>
                    <div class="report-box"><h3>جوانب الإجادة</h3><textarea id="strengthsContent" class="report-content-area" placeholder="..."></textarea></div>
                    <div class="report-box"><h3>الجوانب التي تحتاج إلى تطوير</h3><textarea id="developmentContent" class="report-content-area" placeholder="..."></textarea></div>
                    <div class="report-box"><h3>التوصيات</h3><textarea id="recommendationsContent" class="report-content-area" placeholder="..."></textarea></div>
                </section>

                <section class="visitor-info">
                    <h2>معلومات الزائر</h2>
                    <div class="info-grid">
                        <input id="visitorName" type="text" placeholder="اسم الزائر">
                        <input id="visitorPosition" type="text" placeholder="الوظيفة (مثال: مشرف تربوي)">
                    </div>
                </section>
                
                <p id="status-message"></p>

                <section class="controls">
                    <button type="button" class="archive-btn" onclick="savePermanentReport()">حفظ التقرير</button>
                    <button type="button" class="generate-btn" onclick="generateReport()">توليد تقرير</button>
                    <button class="print-btn" onclick="printOfficialReport()">طباعة</button>
                    <button type="button" class="export-btn" onclick="exportToWord()">تصدير Word</button>
                    <button type="button" class="reset-btn" onclick="showResetModal()">إعادة تعيين</button>
                </section>
            </main>
        </div>

        <div id="dashboard-view">
            <h2>لوحة المتابعة التحليلية</h2>
             <div class="dashboard-controls">
                <div class="control-group">
                    <label for="teacher-dashboard-name">اسم المعلم:</label>
                    <input type="text" id="teacher-dashboard-name" placeholder="أدخل اسم المعلم...">
                </div>
                <div class="control-group">
                     <label for="chartTypeSelect">نوع التحليل:</label>
                     <select id="chartTypeSelect">
                        <option value="line">تطور الأداء عبر الزيارات (خطي)</option>
                        <option value="radar">تحليل زيارة واحدة (راداري)</option>
                        <option value="bar">متوسط الأداء العام (شريطي)</option>
                    </select>
                </div>
                 <div class="control-group" id="visitDateGroup" style="display: none;">
                    <label for="visitDateSelect">اختر الزيارة:</label>
                    <select id="visitDateSelect"></select>
                </div>
                <button onclick="updateDashboardView()">عرض التحليل</button>
            </div>
            <div id="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>
            <div id="no-data-message" style="display: none;">
                <p>لا توجد بيانات محفوظة لهذا المعلم حتى الآن.</p>
            </div>
        </div>

        <div id="saved-reports-view">
            <h2>التقارير المحفوظة</h2>
            <p>هنا يمكنك عرض وتحميل التقارير التي تم حفظها بشكل دائم.</p>
            <div id="saved-reports-list">
                <!-- Reports will be injected here -->
            </div>
            <div id="no-saved-reports-message" style="display: none;">
                <p>لا توجد تقارير محفوظة حتى الآن.</p>
            </div>
        </div>
    </div>
    
    <!-- Modals and Print View -->
    <div id="reset-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>تأكيد إعادة التعيين</h3>
            <p>هل أنت متأكد من رغبتك في إعادة تعيين كافة الحقول؟ سيتم فقدان جميع البيانات المدخلة.</p>
            <div class="modal-buttons">
                <button id="confirm-reset-btn" onclick="performReset()">تأكيد</button>
                <button id="cancel-reset-btn" onclick="hideResetModal()">إلغاء</button>
            </div>
        </div>
    </div>
    <div class="print-view" id="printView">
        <div class="print-container">
             <div class="print-logo-header">
                <img src="https://j.top4top.io/p_35222ql0t1.png" alt="شعار وزارة التربية" class="logo" onerror="this.style.display='none'">
                <img src="https://k.top4top.io/p_3522wfvvr2.png" alt="شعار رؤية عمان 2040" class="logo" onerror="this.style.display='none'">
                <img src="https://l.top4top.io/p_35225xfin3.png" alt="شعار الجودة" class="logo" onerror="this.style.display='none'">
            </div>
            <div class="print-header-text">نموذج رقم (5) استمارة زيارة إشرافية لمعلم مادة - مجال</div>
            <div class="print-title"><h2>استمارة زيارة إشرافية لمعلم مادة/مجال</h2></div>
            
            <table class="print-info-table">
                <tbody>
                    <tr><td class="label">اسم المعلم:</td><td class="value" id="print-teacherName"></td><td class="label">المدرسة:</td><td class="value" id="print-school"></td></tr>
                    <tr><td class="label">المادة/المجال:</td><td class="value" id="print-subject"></td><td class="label">رقم الملف:</td><td class="value" id="print-fileNumber"></td></tr>
                    <tr><td class="label">التاريخ:</td><td class="value" id="print-visitDate"></td><td class="label">رقم الزيارة:</td><td class="value" id="print-visitNumber"></td></tr>
                    <tr><td class="label">الحصة:</td><td class="value" id="print-lesson"></td><td class="label">الصف:</td><td class="value" id="print-class"></td></tr>
                    <tr><td class="label">الموضوع:</td><td colspan="3" class="value" id="print-topic"></td></tr>
                </tbody>
            </table>
            
            <table class="print-main-table">
                <thead>
                    <tr>
                        <th style="width: 20%;">المجال</th>
                        <th style="width: 15%;">المعيار</th>
                        <th style="width: 3%;">م</th>
                        <th>البند</th>
                        <th style="width: 7%;">التقدير</th>
                    </tr>
                </thead>
                <tbody id="print-main-tbody">
                    <!-- Rows generated by script -->
                </tbody>
            </table>

            <div class="report-section-print">
                <h3>جوانب الإجادة في الأداء وأدلتها:</h3>
                <div id="print-strengthsContent" class="print-report-box"></div>
            </div>
            <div class="report-section-print">
                <h3>الجوانب التي تحتاج إلى تطوير في الأداء وأدلتها:</h3>
                <div id="print-developmentContent" class="print-report-box"></div>
            </div>
            <div class="report-section-print">
                <h3>التوصيات:</h3>
                <div id="print-recommendationsContent" class="print-report-box"></div>
            </div>

            <div class="signature-section">
                اسم الزائر: <span id="print-visitorName" class="line"></span><br><br>
                الوظيفة: <span id="print-visitorPosition" class="line"></span>
            </div>
            <div class="evaluation-standard">
                ● معيار التقييم: 1- متميز، 2- جيد، 3- ملائم، 4- غير ملائم، 5- يحتاج إلى تدخل سريع
            </div>
        </div>
    </div>

    <script>
        // --- Globals & Constants ---
        let performanceChartInstance;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;
        if (recognition) {
            recognition.continuous = false;
            recognition.lang = 'ar-SA';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
        }

        const schoolsList = [
            "أبو القاسم الزهراوي", "أبو أيوب الحضرمي", "أبو تمام", "أحمد بن النعمان", 
            "الشيخ سالم السيابي", "الشيخ سعيد الكندي مساني", "الشيخ ناصر الخروصي", 
            "جنادة الازدي", "حفص بن راشد", "خريس الحبوس", "سهيل بن عمرو العامري", 
            "كعب بن زيد", "يزيد الطائي", "أجيال الثقافة", "أجيال الفردوس – الحيل", 
            "البيان", "الجيل المبدع", "الريادة", "الصفوة -المعبيلة", "المجد", 
            "جيفر بن الجلندى", "السراج", "ضياء المستقبل", "مشاعل مسقط سور ال حديد"
        ];

        const evaluationItems = [
            { id: 1, domain: 'الإنجاز الدراسي', standard: 'التحصيل الدراسي', title: 'تحصيل الطلبة في الأعمال الصفية وغير الصفية', desc: '(اكتساب المهارات الحركية والمعارف المرتبطة بها)' },
            { id: 2, domain: 'الإنجاز الدراسي', standard: 'التقدم الدراسي', title: 'التقدم الدراسي للطلبة بما فيهم الطلبة ذوي الإعاقة/الاحتياجات التعليمية', desc: '(تطور الأداء المهاري والخططي)' },
            { id: 3, domain: 'الإنجاز الدراسي', standard: 'مهارات التعلم', title: 'تطبيق مهارات التعلم (الذاتي- التعاوني - الرقمي - التفكير العليا) وربطها بالواقع', desc: '(القيادة، التعاون، التفكير الخططي في مواقف اللعب)' },
            { id: 4, domain: 'النمو الشخصي', standard: 'القيم والسلوك', title: 'تمسك الطلبة بالهوية العمانية والقيم الإنسانية', desc: '(الروح الرياضية وأخلاقيات اللعب)' },
            { id: 5, domain: 'مناخ المدرسة وبيئة التعلم', standard: 'جودة بيئة التعلم', title: 'متابعة جوانب الأمن والسلامة والنظافة في بيئة التعلم', desc: '(سلامة الأدوات والمرافق الرياضية)' },
            { id: 6, domain: 'التدريس والتقويم', standard: 'تخطيط المنهاج الدراسي', title: 'تخطيط المنهاج الدراسي لتحقيق نواتج التعلم', desc: '(التخطيط لتنمية المهارات الحركية واللياقة البدنية)' },
            { id: 7, domain: 'التدريس والتقويم', standard: 'إدارة الصف', title: 'فاعلية الإدارة الصفية', desc: '(إدارة وتنظيم النشاط البدني)' },
            { id: 8, domain: 'التدريس والتقويم', standard: 'فاعلية التدريس', title: 'توظيف استراتيجيات التدريس الفعالة', desc: '(استراتيجيات التدريس المناسبة للنشاط البدني)' },
            { id: 9, domain: 'التدريس والتقويم', standard: 'فاعلية التدريس', title: 'تفعيل المصادر والموارد التعليمية', desc: '(الأدوات والأجهزة والمرافق الرياضية)' },
            { id: 10, domain: 'التدريس والتقويم', standard: 'التقويم ومساندة التقدم', title: 'توظيف أساليب تقويم متنوعة', desc: '(تقويم الأداء الحركي والمهاري للطلبة)' },
            { id: 11, domain: 'القيادة والإدارة والحوكمة', standard: 'قيادة التغيير', title: 'توظيف التقويم الذاتي والتطوير المهني في تحسين الأداء', desc: '(التأمل في الممارسات التدريسية وتطويرها)' },
            { id: 12, domain: 'القيادة والإدارة والحوكمة', standard: 'الحوكمة', title: 'تطبيق السياسات والأنظمة واللوائح المنظمة للعمل', desc: '(الالتزام بأخلاقيات المهنة واللوائح)' },
            { id: 13, domain: 'القيادة والإدارة والحوكمة', standard: 'الحوكمة', title: 'تنفيذ مبادرات وأنشطة تربوية في المجتمع المدرسي', desc: '(تنظيم الفعاليات والمسابقات الرياضية)' }
        ];

        const detailedDescriptions = {
            '1': { // التحصيل الدراسي
                '1': "يكتسب <span class='highlight'>جميع</span> الطلبة المهارات الأساسية والمعارف والمفاهيم في ضوء أهداف الدرس بصورة فعالة.",
                '2': "يكتسب <span class='highlight'>معظم</span> الطلبة المهارات الأساسية والمعارف والمفاهيم في ضوء أهداف الدرس بصورة فاعلة.",
                '3': "يكتسب <span class='highlight'>أغلب</span> الطلبة المهارات الأساسية والمعارف والمفاهيم في ضوء أهداف الدرس بصورة ملائمة أو مقبولة.",
                '4': "يكتسب <span class='highlight'>قليل من</span> الطلبة المهارات الأساسية والمعارف والمفاهيم في ضوء أهداف الدرس بصورة محدودة.",
                '5': "يكتسب <span class='highlight'>عدد نادر من</span> الطلبة المهارات الأساسية والمعارف والمفاهيم في ضوء أهداف الدرس بصورة محدودة جدا / نادرة."
            },
            '2': { // التقدم الدراسي
                '1': "يتقدم <span class='highlight'>جميع</span> الطلبة دراسيا أثناء الحصة بما فيهم الطلبة ذوى الإعاقة/الاحتياجات التعليمية بصورة متميزة.",
                '2': "يتقدم <span class='highlight'>معظم</span> الطلبة دراسيا أثناء الحصة بما فيهم الطلبة ذوى الإعاقة/الاحتياجات التعليمية بصورة فاعلة.",
                '3': "يتقدم <span class='highlight'>أغلب</span> الطلبة دراسيا أثناء الحصة بما فيهم الطلبة ذوى الإعاقة/الاحتياجات التعليمية بصورة ملائمة.",
                '4': "يتقدم <span class='highlight'>قليل من</span> الطلبة دراسيا أثناء الحصة بما فيهم الطلبة ذوى الإعاقة/الاحتياجات التعليمية بصورة محدودة.",
                '5': "يتقدم <span class='highlight'>عدد نادر من</span> الطلبة دراسيا أثناء الحصة بما فيهم الطلبة ذوى الإعاقة/الاحتياجات التعليمية بصورة محدودة جدا."
            },
            '3': { // مهارات التعلم
                '1': "يطبق <span class='highlight'>جميع</span> الطلبة مهارات التعلم الذاتي والتعاوني والرقمي ومهارات التفكير العليا بمستوى متميز.",
                '2': "يطبق <span class='highlight'>معظم</span> الطلبة مهارات التعلم الذاتي والتعاوني والرقمي ومهارات التفكير العليا بمستوى فاعل.",
                '3': "يطبق <span class='highlight'>أغلب</span> الطلبة مهارات التعلم الذاتي والتعاوني والرقمي ومهارات التفكير العليا بمستوى ملائم أو مناسب.",
                '4': "يطبق <span class='highlight'>قليل من</span> الطلبة مهارات التعلم الذاتي والتعاوني والرقمي ومهارات التفكير العليا بمستوى محدود.",
                '5': "يطبق <span class='highlight'>عدد نادر من</span> الطلبة مهارات التعلم الذاتي والتعاوني والرقمي ومهارات التفكير العليا بمستوى محدود جدا/نادر."
            },
             '4': { // القيم والسلوك
                '1': "يلتزم <span class='highlight'>جميع</span> الطلبة بالقيم الإنسانية المشتركة ويراعون ذلك بمستوى متميز.",
                '2': "يلتزم <span class='highlight'>معظم</span> الطلبة بالقيم الإنسانية المشتركة ويراعون ذلك بمستوى فاعل.",
                '3': "يلتزم <span class='highlight'>أغلب</span> الطلبة بالقيم الإنسانية المشتركة، ويراعون ذلك بمستوى ملائم / مناسب.",
                '4': "يلتزم <span class='highlight'>قليل من</span> الطلبة بالقيم الإنسانية المشتركة، ويراعون ذلك بمستوى محدود.",
                '5': "يلتزم <span class='highlight'>عدد محدود جدا</span> من الطلبة بالقيم الإنسانية المشتركة ويراعون ذلك بمستوى محدود جدا ونادر."
            },
            '5': { // جودة بيئة التعلم
                '1': "يتابع المعلم جوانب الأمن والسلامة والنظافة في بيئة التعلم بصورة <span class='highlight'>متميزة</span>.",
                '2': "يتابع المعلم جوانب الأمن والسلامة والنظافة في بيئة التعلم بصورة <span class='highlight'>جيدة</span>.",
                '3': "يتابع المعلم جوانب الأمن والسلامة والنظافة في بيئة التعلم بصورة <span class='highlight'>مناسبة</span>.",
                '4': "يتابع المعلم جوانب الأمن والسلامة والنظافة في بيئة التعلم بصورة <span class='highlight'>محدودة</span>.",
                '5': "يتابع المعلم جوانب الأمن والسلامة والنظافة في بيئة التعلم بصورة <span class='highlight'>نادرة/منعدمة</span>."
            },
            '6': { // تخطيط المنهاج
                '1': "يخطط المعلم <span class='highlight'>لجميع</span> دروسه متسلسلا في تنوع الأهداف مرتبطا بالخطة الفصلية ومحققا لنواتج التعلم بصورة متميزة.",
                '2': "يخطط المعلم <span class='highlight'>معظم</span> دروسه متسلسلا في تنوع الأهداف مرتبطا بالخطة الفصلية ومحققا لنواتج التعلم بصورة جيدة.",
                '3': "يخطط المعلم <span class='highlight'>أغلب</span> دروسه متسلسلا في تنوع الأهداف مرتبطا بالخطة الفصلية ومحققا لنواتج التعلم بصورة مناسبة.",
                '4': "يخطط المعلم <span class='highlight'>قليل من</span> دروسه متسلسلا في تنوع الأهداف مرتبطا بالخطة الفصلية ومحققا لنواتج التعلم بصورة محدودة.",
                '5': "يخطط المعلم <span class='highlight'>عدد محدود جدا</span> من دروسه متسلسلا في تنوع الأهداف مرتبطا بالخطة الفصلية ومحققا لنواتج التعلم بصورة نادرة."
            },
            '7': { // إدارة الصف
                '1': "يقوم المعلم بإدارة زمن التعلم، وسلوك طلبته ويثير دافعيتهم للتعلم بصورة <span class='highlight'>فعالة</span>.",
                '2': "يقوم المعلم بإدارة زمن التعلم، وسلوك طلبته ويثير دافعيتهم للتعلم بصورة <span class='highlight'>جيدة</span>.",
                '3': "يقوم المعلم بإدارة زمن التعلم، وسلوك طلبته ويثير دافعيتهم للتعلم بصورة <span class='highlight'>ملائمة</span>.",
                '4': "يقوم المعلم بإدارة زمن التعلم، وسلوك طلبته ويثير دافعيتهم للتعلم بصورة <span class='highlight'>محدودة</span>.",
                '5': "يقوم المعلم بإدارة زمن التعلم، وسلوك طلبته ويثير دافعيتهم للتعلم بصورة <span class='highlight'>نادرة</span>."
            },
            '8': { // استراتيجيات التدريس
                '1': "توظيف استراتيجيات تدريس فعالة بحيث يستفيد منها جميع الطلبة في تعميق تعلمهم بمستوى متميز.",
                '2': "يوظف المعلم استراتيجيات تدريس فعالة بحيث يستفيد منها <span class='highlight'>معظم</span> الطلبة في تعميق تعلمهم بمستوى فاعل.",
                '3': "يوظف المعلم استراتيجيات تدريس فعالة بحيث يستفيد منها <span class='highlight'>أغلب</span> الطلبة في تعميق تعلمهم بمستوى ملائم.",
                '4': "يوظف المعلم استراتيجيات تدريس فعالة بحيث يستفيد منها <span class='highlight'>قليل من</span> الطلبة في تعميق تعلمهم بمستوى محدود.",
                '5': "يوظف المعلم استراتيجيات تدريس فعالة بحيث يستفيد منها <span class='highlight'>عدد قليل جدا</span> من الطلبة في تعميق تعلمهم بمستوى نادر."
            },
             '9': { // المصادر والموارد
                '1': "يفعل المعلم التقنيات الرقمية والمنصات والسبورات التفاعلية والذكاء الاصطناعي بحيث يستفيد منها <span class='highlight'>جميع</span> الطلبة في تعميق تعلمهم بمستوى متميز.",
                '2': "يفعل المعلم التقنيات الرقمية والمنصات والسبورات التفاعلية والذكاء الاصطناعي بحيث يستفيد منها <span class='highlight'>معظم</span> الطلبة في تعميق تعلمهم بمستوى جيد.",
                '3': "يفعل المعلم التقنيات الرقمية والمنصات والسبورات التفاعلية والذكاء الاصطناعي بحيث يستفيد منها <span class='highlight'>أغلب</span> الطلبة في تعميق تعلمهم بمستوى ملائم.",
                '4': "يفعل المعلم التقنيات الرقمية والمنصات والسبورات التفاعلية والذكاء الاصطناعي بحيث يستفيد منها <span class='highlight'>قليل من</span> الطلبة في تعميق تعلمهم بمستوى محدود.",
                '5': "يفعل المعلم التقنيات الرقمية والمنصات والسبورات التفاعلية والذكاء الاصطناعي بحيث يستفيد منها <span class='highlight'>قليل جدا من</span> الطلبة في تعميق تعلمهم بمستوى نادر."
            },
            '10': { // أساليب التقويم
                '1': "يوظف المعلم أساليب تقويم متنوعة؛ يراعى التمايز بين <span class='highlight'>جميع</span> الطلبة بما ينعكس على تعلمهم بمستوى متميز.",
                '2': "يوظف المعلم أساليب تقويم متنوعة؛ يراعى التمايز بين <span class='highlight'>معظم</span> الطلبة بما ينعكس على تعلمهم بمستوى فاعل.",
                '3': "يوظف المعلم أساليب تقويم متنوعة؛ يراعى التمايز بين <span class='highlight'>أغلب</span> الطلبة بما ينعكس على تعلمهم بمستوى ملائم.",
                '4': "يوظف المعلم أساليب تقويم متنوعة؛ يراعى التمايز بين <span class='highlight'>قليل من</span> الطلبة بما ينعكس على تعلمهم بمستوى محدود.",
                '5': "يوظف المعلم أساليب تقويم متنوعة؛ يراعى التمايز بين <span class='highlight'>قليل جدا من</span> الطلبة بما ينعكس على تعلمهم بمستوى نادر."
            },
            '11': { // التقويم الذاتي
                '1': "يجري المعلم تقويما لأدائه ذاتيا ويوظفه في تحسين تعلم <span class='highlight'>جميع</span> الطلبة بمستوى متميز.",
                '2': "يجري المعلم تقويما لأدائه ذاتيا ويوظفه في تحسين تعلم <span class='highlight'>معظم</span> الطلبة بمستوى فاعل.",
                '3': "يجري المعلم تقويما لأدائه ذاتيا ويوظفه في تحسين تعلم <span class='highlight'>أغلب</span> الطلبة بمستوى مناسب.",
                '4': "يجري المعلم تقويما لأدائه ذاتيا ويوظفه في تحسين تعلم <span class='highlight'>قليل من</span> الطلبة بمستوى محدود.",
                '5': "يجري المعلم تقويما لأدائه ذاتيا ويوظفه في تحسين تعلم <span class='highlight'>قليل جدا من</span> الطلبة بمستوى نادر."
            },
            '12': { // السياسات والأنظمة
                '1': "يطبق السياسات والأنظمة واللوائح المنظمة للعمل بصورة <span class='highlight'>فعالة</span>.",
                '2': "يطبق السياسات والأنظمة واللوائح المنظمة للعمل بصورة <span class='highlight'>فاعلة</span>.", // Note: PDF has "فاعلة" for both 1 and 2
                '3': "يطبق السياسات والأنظمة واللوائح المنظمة للعمل بصورة <span class='highlight'>مناسبة</span>.",
                '4': "يطبق السياسات والأنظمة واللوائح المنظمة للعمل بصورة <span class='highlight'>محدودة</span>.",
                '5': "يطبق السياسات والأنظمة واللوائح المنظمة للعمل بصورة <span class='highlight'>نادرة</span>."
            },
            '13': { // المبادرات
                '1': "يقدم مبادرات فعالة لدعم وتحسين العملية التعليمية، كما يتميز بالتفاعل الإيجابي في <span class='highlight'>جميع</span> الأنشطة التربوية والمجتمع المحلي.",
                '2': "يقدم مبادرات فاعلة لدعم وتحسين العملية التعليمية، كما يتميز بالتفاعل الإيجابي في <span class='highlight'>معظم</span> الأنشطة التربوية والمجتمع المحلي.",
                '3': "يقدم مبادرات ملائمة لدعم وتحسين العملية التعليمية، كما يتفاعل إيجابيا في <span class='highlight'>أغلب</span> الأنشطة التربوية والمجتمع المحلي.",
                '4': "يقدم مبادرات محدودة لدعم وتحسين العملية التعليمية، كما يتفاعل بشكل <span class='highlight'>محدود</span> مع الأنشطة التربوية والمجتمع المحلي.",
                '5': "<span class='highlight'>نادرا</span> ما يقدم مبادرات لدعم وتحسين العملية التعليمية كما أن تفاعله مع الأنشطة التربوية والمجتمع المحلي <span class='highlight'>محدود جدا</span>."
            }
        };


        const instructionalRecommendations = {
            '1': "احرص على تنويع استراتيجيات التدريس والتقويم لضمان اكتساب جميع الطلبة للمهارات الحركية والمعارف المرتبطة بالمادة بفاعلية.",
            '2': "اعمل على متابعة التقدم الفردي لجميع الطلبة، بمن فيهم ذوي الاحتياجات التعليمية، وقدم الدعم اللازم لضمان تطور أدائهم المهاري والخططي بشكل مستمر خلال الحصة.",
            '3': "احرص على تمكين جميع طلبتك من تطبيق مهارات التعلم المتنوعة (الذاتي، التعاوني، الرقمي) وتنمية مهارات التفكير العليا لديهم، مع التأكيد على ربط ما يتعلمونه بواقع حياتهم لتعميق أثر التعلم.",
            '4': "اعمل على ترسيخ الهوية العمانية والقيم الإنسانية المشتركة في نفوس طلبتك، وشجعهم على الالتزام بها سلوكًا وممارسةً في جميع المواقف داخل المدرسة وخارجها.",
            '5': "تأكد باستمرار من سلامة الأدوات والمرافق الرياضية، وعزز لدى الطلبة أهمية المحافظة على بيئة تعلم آمنة ونظيفة.",
            '6': "استمر في تخطيط الدروس بشكل منهجي ومتسلسل، مع ربط الأهداف بالخطة الفصلية وتنويع الاستراتيجيات والأنشطة لتلبية احتياجات جميع الطلبة.",
            '7': "وظف استراتيجيات فعالة لإدارة وتنظيم النشاط البدني، واستثمر وقت الحصة بالكامل في ممارسة الأنشطة الحركية الهادفة لرفع دافعية الطلبة.",
            '8': "احرص على توظيف استراتيجيات تدريس متنوعة ومناسبة للنشاط البدني، بما يضمن استفادة جميع الطلبة في تعميق تعلمهم للمهارات الحركية.",
            '9': "اعمل على تفعيل جميع المصادر والموارد التعليمية المتاحة، بما في ذلك الأدوات والأجهزة الرياضية والمنصات الرقمية، لإثراء تجربة التعلم لدى الطلبة.",
            '10': "وظف أساليب تقويم متنوعة ومناسبة للأداء الحركي، مع تقديم تغذية راجعة فورية وبناءة لدعم تقدم جميع الطلبة وتلبية الفروق الفردية بينهم.",
            '11': "استمر في تقويم أدائك ذاتيًا والتأمل في ممارساتك التدريسية، ووظف نتائج هذا التأمل في تطوير خططك وأساليبك لتحسين تعلم الطلبة بشكل مستمر.",
            '12': "التزم دائماً بأخلاقيات المهنة والسياسات واللوائح المنظمة للعمل، وكن نموذجاً يحتذى به للطلبة والزملاء.",
            '13': "بادر بتنفيذ أنشطة ومسابقات رياضية فاعلة في المجتمع المدرسي، وعزز تفاعلك الإيجابي مع الأنشطة التربوية والمجتمع المحلي."
        };


        // --- All JS Functions Definition ---
        // VIEWS
        function toggleView(viewId) {
            document.querySelectorAll('#form-view, #dashboard-view, #saved-reports-view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');

            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.nav-tab[onclick="toggleView('${viewId}')"]`).classList.add('active');

            if (viewId === 'saved-reports-view') {
                renderSavedReports();
            }
        }
        
        // SCORING
        function updateScore(itemId, score) {
            const mainScoreDisplay = document.getElementById(`score-${itemId}`);
            mainScoreDisplay.textContent = score;
            updateScoreColor(mainScoreDisplay, score);

            // Update rating buttons UI
            const ratingContainer = document.querySelector(`#item-${itemId} .rating-selector`);
            ratingContainer.querySelectorAll('.rating-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.dataset.score == score) {
                    btn.classList.add('active');
                }
            });

            // Update notes with description
            const notesDiv = document.getElementById(`notes-${itemId}`);
            if(detailedDescriptions[itemId] && detailedDescriptions[itemId][score]) {
                notesDiv.innerHTML = detailedDescriptions[itemId][score];
            } else {
                notesDiv.innerHTML = '';
            }
        }
        
        function updateScoreColor(element, score) {
            element.style.backgroundColor = '#f0f2f5';
            element.style.color = '#333';
            if (score == 1) { element.style.backgroundColor = '#d4edda'; element.style.color = '#155724'; } // Excellent
            else if (score == 2) { element.style.backgroundColor = '#cce5ff'; element.style.color = '#004085'; } // Good
            else if (score == 3) { element.style.backgroundColor = '#fff3cd'; element.style.color = '#856404'; } // Appropriate
            else if (score == 4) { element.style.backgroundColor = '#f8d7da'; element.style.color = '#721c24'; } // Inappropriate
            else if (score == 5) { element.style.backgroundColor = '#dc3545'; element.style.color = '#fff'; } // Urgent
        }
        
        
        // FORM & DATA
        function generateEvaluationForm() {
            const formContainer = document.getElementById('evaluationForm');
            formContainer.innerHTML = '';
            let currentDomain = '';
            let detailsElement;

            evaluationItems.forEach(item => {
                if(item.domain !== currentDomain) {
                    currentDomain = item.domain;
                    detailsElement = document.createElement('details');
                    detailsElement.open = true;
                    const summary = document.createElement('summary');
                    summary.textContent = currentDomain;
                    detailsElement.appendChild(summary);
                    formContainer.appendChild(detailsElement);
                }

                const itemCardHTML = `
                    <div class="item-card" id="item-${item.id}">
                        <div class="item-header">
                            <h4>${item.id}. ${item.title} <br><small>${item.desc}</small></h4>
                            <div class="score" id="score-${item.id}">3</div>
                        </div>
                        <div class="rating-selector">
                           <button type="button" class="rating-btn score-1" data-score="1" onclick="updateScore(${item.id}, 1)">متميز</button>
                           <button type="button" class="rating-btn score-2" data-score="2" onclick="updateScore(${item.id}, 2)">جيد</button>
                           <button type="button" class="rating-btn score-3 active" data-score="3" onclick="updateScore(${item.id}, 3)">ملائم</button>
                           <button type="button" class="rating-btn score-4" data-score="4" onclick="updateScore(${item.id}, 4)">غير ملائم</button>
                           <button type="button" class="rating-btn score-5" data-score="5" onclick="updateScore(${item.id}, 5)">تدخل سريع</button>
                        </div>
                        <div class="notes-wrapper">
                            <div id="notes-${item.id}" class="item-notes" contenteditable="true"></div>
                            ${recognition ? `<button type="button" class="mic-btn" onclick="startDictation('notes-${item.id}', this)">🎤</button>` : ''}
                        </div>
                    </div>
                `;
                detailsElement.innerHTML += itemCardHTML;
            });
             evaluationItems.forEach(item => {
                updateScore(item.id, 3); // Set initial state
            });
        }
        
        function getSchoolName() {
            const schoolSelect = document.getElementById('school');
            return schoolSelect.value === 'other' ? document.getElementById('school-other').value.trim() : schoolSelect.value;
        }

        function getTeacherName() {
            return document.getElementById('teacherName').value.trim();
        }
        
        function populateDropdown(selectElement, dataArray, placeholderText) {
            selectElement.innerHTML = `<option value="">${placeholderText}</option>`;
            dataArray.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                selectElement.appendChild(option);
            });
            selectElement.innerHTML += `<option value="other">أخرى...</option>`;
        }
        
        function handleOtherOption(selectElement, otherInputElement) {
            if (selectElement.value === 'other') {
                otherInputElement.style.display = 'block';
            } else {
                otherInputElement.style.display = 'none';
                otherInputElement.value = '';
            }
        }

        // ACTIONS (Print, Export, Report)
        function prepareOfficialPrint() {
            const printTbody = document.getElementById('print-main-tbody');
            printTbody.innerHTML = ''; 

            document.getElementById('print-school').textContent = getSchoolName();
            document.getElementById('print-teacherName').textContent = getTeacherName();
            document.getElementById('print-fileNumber').textContent = document.getElementById('fileNumber').value;
            document.getElementById('print-subject').textContent = document.getElementById('subject').value;
            document.getElementById('print-visitNumber').textContent = document.getElementById('visitNumber').value;
            document.getElementById('print-visitDate').textContent = document.getElementById('visitDate').value;
            document.getElementById('print-class').textContent = document.getElementById('class').value;
            document.getElementById('print-lesson').textContent = document.getElementById('lesson').value;
            document.getElementById('print-topic').textContent = document.getElementById('topic').value;
            document.getElementById('print-visitorName').textContent = document.getElementById('visitorName').value;
            document.getElementById('print-visitorPosition').textContent = document.getElementById('visitorPosition').value;

            document.getElementById('print-strengthsContent').innerText = document.getElementById('strengthsContent').value;
            document.getElementById('print-developmentContent').innerText = document.getElementById('developmentContent').value;
            document.getElementById('print-recommendationsContent').innerText = document.getElementById('recommendationsContent').value;

             // Group items by domain and then by standard
            const groupedItems = evaluationItems.reduce((acc, item) => {
                acc[item.domain] = acc[item.domain] || {};
                (acc[item.domain][item.standard] = acc[item.domain][item.standard] || []).push(item);
                return acc;
            }, {});

            let isFirstRow = true;
            for (const domain in groupedItems) {
                const standards = groupedItems[domain];
                const domainItemCount = Object.values(standards).flat().length;
                let isFirstStandardInDomain = true;
                
                for(const standard in standards) {
                    const items = standards[standard];
                    const standardItemCount = items.length;
                    
                    items.forEach((item, itemIndex) => {
                        const row = document.createElement('tr');
                        const score = document.getElementById(`score-${item.id}`).textContent;
                        
                        let domainCell = '';
                        let standardCell = '';

                        if(isFirstStandardInDomain && isFirstRow) {
                             domainCell = `<td rowspan="${domainItemCount}" class="category-cell">${domain}</td>`;
                             isFirstRow = false;
                        } else if (itemIndex === 0 && isFirstStandardInDomain) {
                            domainCell = `<td rowspan="${domainItemCount}" class="category-cell">${domain}</td>`;
                        }
                        
                         if (itemIndex === 0) {
                            standardCell = `<td rowspan="${standardItemCount}" class="category-cell">${standard}</td>`;
                        }

                        row.innerHTML = `${domainCell}${standardCell}<td>${item.id}</td><td class="item-cell">${item.title}</td><td>${score}</td>`;
                        printTbody.appendChild(row);
                    });
                     isFirstStandardInDomain = false;
                }
                isFirstRow = true; // Reset for next domain
            }
        }


        function printOfficialReport() {
            prepareOfficialPrint();
            window.print();
        }
        
        function exportToWord() {
            prepareOfficialPrint();
            const visitNumber = document.getElementById('visitNumber').value.trim() || 'زيارة';
            const schoolName = getSchoolName() || 'مدرسة';
            const teacherName = getTeacherName() || 'معلم';
            const fileName = `${visitNumber} - ${schoolName} - ${teacherName}.docx`;

            const content = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
                    <style>
                        body { font-family: 'Times New Roman', Times, serif; direction: rtl; }
                        /* Add all print styles here */
                    </style>
                </head>
                <body>${document.getElementById("printView").innerHTML}</body>
                </html>
            `;
            const converted = htmlDocx.asBlob(content, {
                orientation: 'portrait',
                margins: { top: 720, right: 720, bottom: 720, left: 720 }
            });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(converted);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
       
        function generateReport() {
            let strengths = [];
            let developments = [];
            let recommendations = [];

            evaluationItems.forEach(item => {
                const score = parseInt(document.getElementById(`score-${item.id}`).textContent);
                const notes = document.getElementById(`notes-${item.id}`).innerHTML;
                
                if (score <= 2) {
                    strengths.push({title: item.title, standard: item.standard, notes: notes});
                }
                if (score >= 4) {
                    developments.push({title: item.title, standard: item.standard, notes: notes});
                    recommendations.push({ id: item.id, title: item.title, standard: item.standard });
                }
                if (score === 3) {
                     recommendations.push({ id: item.id, title: item.title, standard: item.standard });
                }
            });
            
            let recommendationsText = "نوصي المعلم بالآتي:\n\n";
            recommendations.forEach(rec => {
                 if(instructionalRecommendations[rec.id]) {
                     recommendationsText += `• ${rec.standard} - ${rec.title}: ${instructionalRecommendations[rec.id]}\n\n`;
                 }
            });
            recommendationsText += "والله ولي التوفيق.";

            document.getElementById('strengthsContent').value = strengths.slice(0, 4).map(s => `${s.standard}: ${s.notes.replace(/<[^>]*>?/gm, '')}`).join('\n\n');
            document.getElementById('developmentContent').value = developments.slice(0, 4).map(d => `${d.standard}: ${d.notes.replace(/<[^>]*>?/gm, '')}`).join('\n\n');
            document.getElementById('recommendationsContent').value = recommendationsText;

            document.getElementById('reportSection').style.display = 'block';
            document.getElementById('reportSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        function startDictation(textareaId, button) {
            if (!recognition) {
                alert('عذراً، متصفحك لا يدعم خاصية الإملاء الصوتي.');
                return;
            }
            
            const notesDiv = document.getElementById(textareaId);
            button.classList.add('recording');
            button.textContent = '🔴';

            recognition.start();

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                 notesDiv.innerHTML += (notesDiv.textContent.length > 0 ? ' ' : '') + transcript;
            };

            recognition.onspeechend = function() {
                recognition.stop();
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                alert(`حدث خطأ في التعرف على الصوت: ${event.error}`);
            };

            recognition.onend = function() {
                button.classList.remove('recording');
                button.textContent = '🎤';
            };
        }


        // MODAL & RESET
        function showResetModal() {
            document.getElementById('reset-modal').style.display = 'flex';
        }

        function hideResetModal() {
            document.getElementById('reset-modal').style.display = 'none';
        }

        function performReset() {
            clearForm();
            hideResetModal();
            displayStatusMessage('تم مسح النموذج الحالي بنجاح.', 'green');
        }
        
        function clearForm() {
            document.getElementById('evaluationForm').reset();
             const schoolSelect = document.getElementById('school');
            schoolSelect.selectedIndex = 0;
            schoolSelect.dispatchEvent(new Event('change'));
             document.querySelectorAll('.info-grid input, .report-content-area').forEach(input => {
                 input.value = '';
            });
            evaluationItems.forEach(item => {
                 updateScore(item.id, 3);
            });
            document.getElementById('reportSection').style.display = 'none';
        }


        // DATA PERSISTENCE & ARCHIVING
        function displayStatusMessage(message, color) {
            const statusElement = document.getElementById('status-message');
            statusElement.textContent = message;
            statusElement.style.color = color;
            statusElement.style.opacity = 1;
            setTimeout(() => { statusElement.style.opacity = 0; }, 3000);
        }
        
        function savePermanentReport() {
            const teacherName = getTeacherName();
            const visitDate = document.getElementById('visitDate').value;
            if (!teacherName || !visitDate) {
                alert('الرجاء إدخال اسم المعلم وتاريخ الزيارة قبل الحفظ.');
                return;
            }
            
            const reportId = `visit_v5_${Date.now()}`;
            const reportData = {
                id: reportId,
                teacherName: teacherName,
                visitDate: visitDate,
                school: getSchoolName(),
                formData: {}
            };

            document.querySelectorAll('input, select, textarea').forEach(el => {
                if (el.id) reportData.formData[el.id] = el.value;
            });
            evaluationItems.forEach(item => {
                reportData.formData[`score-${item.id}`] = document.getElementById(`score-${item.id}`).textContent;
                reportData.formData[`notes-${item.id}`] = document.getElementById(`notes-${item.id}`).innerHTML;
            });

            localStorage.setItem(reportId, JSON.stringify(reportData));
            
            const visitDataForDashboard = { date: visitDate, scores: {} };
            for(let i = 1; i <= evaluationItems.length; i++) {
                 const scoreEl = document.getElementById(`score-${i}`);
                 if (scoreEl) {
                    visitDataForDashboard.scores[`item-${i}`] = parseInt(scoreEl.textContent) || 3;
                 }
            }
            const teacherArchiveKey = `teacher_archive_v5_${teacherName}`;
            let archive = JSON.parse(localStorage.getItem(teacherArchiveKey)) || [];
            const existingVisitIndex = archive.findIndex(v => v.date === visitDate);

            if (existingVisitIndex > -1) {
                archive[existingVisitIndex] = visitDataForDashboard;
            } else {
                archive.push(visitDataForDashboard);
            }
            archive.sort((a, b) => new Date(a.date) - new Date(b.date));
            localStorage.setItem(teacherArchiveKey, JSON.stringify(archive));

            displayStatusMessage(`تم حفظ التقرير للمعلم: ${teacherName} بنجاح!`, '#3f51b5');
        }

        function loadPermanentReport(reportKey) {
            const data = JSON.parse(localStorage.getItem(reportKey));
            if (data && data.formData) {
                clearForm(); 
                Object.keys(data.formData).forEach(key => {
                    const el = document.getElementById(key);
                    if (el) {
                        if (el.classList.contains('item-notes')) {
                             el.innerHTML = data.formData[key];
                        } else if (el.tagName === 'DIV' && el.classList.contains('score')) {
                            el.textContent = data.formData[key];
                        } else {
                            el.value = data.formData[key];
                        }
                        if (el.tagName === 'SELECT') {
                            el.dispatchEvent(new Event('change'));
                        }
                    }
                });

                evaluationItems.forEach(item => {
                    const score = parseInt(data.formData[`score-${item.id}`] || 3);
                    updateScore(item.id, score);
                });
                
                toggleView('form-view');
                displayStatusMessage(`تم تحميل التقرير المحفوظ.`, '#007bff');
            }
        }

        function deletePermanentReport(reportKey) {
            const data = JSON.parse(localStorage.getItem(reportKey));
             if (!data || !confirm(`هل أنت متأكد من حذف هذا التقرير للمعلم ${data.teacherName} بتاريخ ${data.visitDate}؟ لا يمكن التراجع عن هذا الإجراء.`)) {
                return;
            }

            localStorage.removeItem(reportKey);

            const teacherArchiveKey = `teacher_archive_v5_${data.teacherName}`;
            let archive = JSON.parse(localStorage.getItem(teacherArchiveKey)) || [];
            const updatedArchive = archive.filter(visit => visit.date !== data.visitDate);
            if (updatedArchive.length > 0) {
                localStorage.setItem(teacherArchiveKey, JSON.stringify(updatedArchive));
            } else {
                localStorage.removeItem(teacherArchiveKey); 
            }

            renderSavedReports(); 
            displayStatusMessage(`تم حذف التقرير بنجاح.`, 'red');
        }


        function saveVisitorData() {
            const visitorData = {
                name: document.getElementById('visitorName').value,
                position: document.getElementById('visitorPosition').value
            };
            localStorage.setItem('visitorData_v5', JSON.stringify(visitorData));
        }

        function loadVisitorData() {
            const visitorData = JSON.parse(localStorage.getItem('visitorData_v5'));
            if(visitorData) {
                document.getElementById('visitorName').value = visitorData.name || 'أسعد بن محفوظ الخصيبي';
                document.getElementById('visitorPosition').value = visitorData.position || 'مشرف رياضة مدرسية';
            } else {
                 document.getElementById('visitorName').value = 'أسعد بن محفوظ الخصيبي';
                 document.getElementById('visitorPosition').value = 'مشرف رياضة مدرسية';
            }
        }
        
        function saveTemplate() {
            const templateName = prompt("الرجاء إدخال اسم للقالب:");
            if (!templateName) return;

            const data = {};
            document.querySelectorAll('input, select').forEach(el => {
                if (el.id) data[el.id] = el.value;
            });
             evaluationItems.forEach(item => {
                data[`score-${item.id}`] = document.getElementById(`score-${item.id}`).textContent;
                data[`notes-${item.id}`] = document.getElementById(`notes-${item.id}`).innerHTML;
            });


            let templates = JSON.parse(localStorage.getItem('evaluationTemplates_v5')) || {};
            templates[templateName] = data;
            localStorage.setItem('evaluationTemplates_v5', JSON.stringify(templates));
            populateTemplateDropdown();
            displayStatusMessage(`تم حفظ القالب "${templateName}" بنجاح.`, 'green');
        }

        function loadTemplate() {
            const templateName = document.getElementById('template-select').value;
            if (!templateName) return;

            const templates = JSON.parse(localStorage.getItem('evaluationTemplates_v5')) || {};
            const data = templates[templateName];

            if (data) {
                Object.keys(data).forEach(key => {
                    const el = document.getElementById(key);
                    if (el) {
                        if(el.classList.contains('item-notes')) {
                            el.innerHTML = data[key];
                        }
                        else if (el.tagName === 'DIV' && el.classList.contains('score')) {
                             el.textContent = data[key];
                        }
                        else el.value = data[key];

                        if (el.tagName === 'SELECT') {
                            el.dispatchEvent(new Event('change'));
                        }
                    }
                });
                evaluationItems.forEach(item => {
                    const score = parseInt(document.getElementById(`score-${item.id}`).textContent);
                    updateScore(item.id, score);
                });
                displayStatusMessage(`تم تحميل القالب "${templateName}".`, '#007bff');
            }
        }

        function populateTemplateDropdown() {
            const select = document.getElementById('template-select');
            const templates = JSON.parse(localStorage.getItem('evaluationTemplates_v5')) || {};
            select.innerHTML = '<option value="">اختر قالبًا...</option>';
            for (const name in templates) {
                select.innerHTML += `<option value="${name}">${name}</option>`;
            }
        }

        // DASHBOARD & SAVED REPORTS
        function renderSavedReports() {
            const listContainer = document.getElementById('saved-reports-list');
            const noReportsMessage = document.getElementById('no-saved-reports-message');
            listContainer.innerHTML = '';
            let reportsFound = false;

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('visit_v5_')) {
                    reportsFound = true;
                    const data = JSON.parse(localStorage.getItem(key));
                    const schoolName = data.school === 'other' ? data.formData['school-other'] : data.school;
                    
                    const card = document.createElement('div');
                    card.className = 'saved-report-card';
                    card.innerHTML = `
                        <div class="saved-report-info">
                            <strong>المعلم:</strong> ${data.teacherName}<br>
                            <strong>المدرسة:</strong> ${schoolName}<br>
                            <strong>التاريخ:</strong> ${data.visitDate}
                        </div>
                        <div class="saved-report-actions">
                            <button class="generate-btn" onclick="loadPermanentReport('${key}')">تحميل</button>
                            <button class="reset-btn" onclick="deletePermanentReport('${key}')">حذف</button>
                        </div>
                    `;
                    listContainer.appendChild(card);
                }
            }
            
            if (noReportsMessage) {
                noReportsMessage.style.display = reportsFound ? 'none' : 'block';
            }
        }

        function loadTeacherDashboard() {
            const teacherName = document.getElementById('teacher-dashboard-name').value.trim();
             if (!teacherName) {
                alert('الرجاء إدخال اسم معلم.');
                return;
            }

            const teacherArchiveKey = `teacher_archive_v5_${teacherName}`;
            const archive = JSON.parse(localStorage.getItem(teacherArchiveKey));
            
            const chartContainer = document.getElementById('chart-container');
            const noDataMessage = document.getElementById('no-data-message');
            const visitDateGroup = document.getElementById('visitDateGroup');

            if (!archive || archive.length === 0) {
                chartContainer.style.display = 'none';
                if(noDataMessage) noDataMessage.style.display = 'block';
                 if (performanceChartInstance) {
                    performanceChartInstance.destroy();
                }
                visitDateGroup.style.display = 'none';
                return;
            }

            chartContainer.style.display = 'block';
            if(noDataMessage) noDataMessage.style.display = 'none';

            // Populate visit dates for radar chart
            const visitDateSelect = document.getElementById('visitDateSelect');
            visitDateSelect.innerHTML = '';
            archive.forEach(visit => {
                visitDateSelect.innerHTML += `<option value="${visit.date}">${visit.date}</option>`;
            });

            updateDashboardView();
        }

        function updateDashboardView() {
            const chartType = document.getElementById('chartTypeSelect').value;
            const visitDateGroup = document.getElementById('visitDateGroup');
            visitDateGroup.style.display = chartType === 'radar' ? 'block' : 'none';

            if (performanceChartInstance) {
                performanceChartInstance.destroy();
            }

            const teacherName = document.getElementById('teacher-dashboard-name').value.trim();
            if (!teacherName) return;

            const teacherArchiveKey = `teacher_archive_v5_${teacherName}`;
            const archive = JSON.parse(localStorage.getItem(teacherArchiveKey));
            if (!archive || archive.length === 0) return;

            const ctx = document.getElementById('performanceChart').getContext('2d');
            const labels = evaluationItems.map(item => item.title);
            const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#8D6E63', '#EC407A', '#7E57C2', '#26A69A', '#D4E157', '#FF7043', '#78909C', '#5C6BC0'];

            let chartConfig;

            if (chartType === 'line') {
                const datasets = evaluationItems.map((item, index) => ({
                    label: item.title,
                    data: archive.map(visit => visit.scores[`item-${item.id}`] || 0),
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '33',
                    fill: false,
                    tension: 0.1
                }));
                 chartConfig = { type: 'line', data: { labels: archive.map(v => v.date), datasets }, options: { /* ... options for line ... */ } };
            } else if (chartType === 'radar') {
                 const selectedDate = document.getElementById('visitDateSelect').value;
                 const visitData = archive.find(v => v.date === selectedDate);
                 const data = visitData ? evaluationItems.map(item => visitData.scores[`item-${item.id}`] || 0) : [];
                 chartConfig = { type: 'radar', data: { labels, datasets: [{ label: `أداء زيارة ${selectedDate}`, data, backgroundColor: 'rgba(54, 162, 235, 0.2)', borderColor: 'rgb(54, 162, 235)', pointBackgroundColor: 'rgb(54, 162, 235)' }] }, options: { /* ... options for radar ... */ } };
            } else if (chartType === 'bar') {
                const avgScores = evaluationItems.map(item => {
                    const scores = archive.map(visit => visit.scores[`item-${item.id}`] || 0);
                    const sum = scores.reduce((a, b) => a + b, 0);
                    return sum / scores.length || 0;
                });
                chartConfig = { type: 'bar', data: { labels, datasets: [{ label: 'متوسط الأداء العام', data: avgScores, backgroundColor: colors }] }, options: { /* ... options for bar ... */ } };
            }

            // Common options
            chartConfig.options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: `تحليل أداء المعلم: ${teacherName}`, font: { size: 18, family: 'Tajawal' } },
                    legend: { display: chartType !== 'bar', position: 'top', labels: { font: { family: 'Tajawal' } } }
                },
                scales: {
                    y: { reverse: true, min: 1, max: 5, ticks: { stepSize: 1, callback: (v) => ['متميز', 'جيد', 'ملائم', 'غير ملائم', 'تدخل سريع'][v-1] } },
                    r: { reverse: true, min: 1, max: 5, ticks: { stepSize: 1, backdropColor: 'transparent', callback: (v) => ['متميز', 'جيد', 'ملائم', 'غير ملائم', ''][v-1] } }
                }
            };


            performanceChartInstance = new Chart(ctx, chartConfig);
        }
        
        // --- Document Ready / Initial Setup ---
        document.addEventListener('DOMContentLoaded', function() {
            generateEvaluationForm();

            const schoolSelect = document.getElementById('school');
            const schoolOtherInput = document.getElementById('school-other');
            populateDropdown(schoolSelect, schoolsList, 'اختر المدرسة...');
            schoolSelect.addEventListener('change', () => handleOtherOption(schoolSelect, schoolOtherInput));

            populateTemplateDropdown();
            loadVisitorData();
            
            document.getElementById('confirm-reset-btn').addEventListener('click', performReset);
            document.getElementById('cancel-reset-btn').addEventListener('click', hideResetModal);
            document.getElementById('reset-modal').addEventListener('click', (e) => {
                if (e.target.id === 'reset-modal') hideResetModal();
            });

            document.getElementById('visitorName').addEventListener('input', saveVisitorData);
            document.getElementById('visitorPosition').addEventListener('input', saveVisitorData);
            document.getElementById('teacher-dashboard-name').addEventListener('change', loadTeacherDashboard);
            document.getElementById('chartTypeSelect').addEventListener('change', updateDashboardView);
             document.getElementById('visitDateSelect').addEventListener('change', updateDashboardView);


            // Set initial view
            toggleView('form-view');
        });
    </script>
</body>
</html>

